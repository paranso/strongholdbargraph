<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roasting Profile Timeline</title>
    <!-- SheetJS 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* --- CSS 스타일 (글자 크기 약간 축소) --- */
        body { font-family: sans-serif; background-color: #f8f9fa; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background-color: #fff; padding: 20px 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; margin-bottom: 30px; color: #343a40; font-size: 24px; font-weight: 600; }
        .upload-section { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px 20px; margin-bottom: 30px; padding: 15px; }
        .file-label { cursor: pointer; display: inline-flex; align-items: center; padding: 8px 16px; border: 1px solid #dee2e6; border-radius: 20px; background-color: #e7f5ff; color: #1c7ed6; font-size: 14px; font-weight: 500; transition: background-color 0.2s ease; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .file-label:hover { background-color: #d0ebff; }
        .file-label svg { width: 16px; height: 16px; margin-right: 6px; fill: currentColor; }
        #fileInput { display: none; }
        #fileCount { font-size: 14px; color: #868e96; }
        #resetButton { background: none; border: none; color: #f03e3e; font-size: 12px; text-decoration: underline; cursor: pointer; padding: 5px; }
        #resetButton:hover { color: #c92a2a; }
        .profiles-container { border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; background-color: #ffffff; overflow-x: auto; }
        .profiles-container h2 { margin-top: 0; margin-bottom: 20px; font-size: 18px; font-weight: 600; color: #495057; }
        .profile-row { margin-bottom: 25px; min-width: 700px; }
        .timeline-bar-container { position: relative; height: 28px; background-color: #f1f3f5; border-radius: 3px; margin-bottom: 5px; }
        .phase-bar { position: absolute; top: 0; height: 100%; display: flex; align-items: center; justify-content: flex-start; padding-left: 8px; box-sizing: border-box; overflow: hidden; border-right: 1px solid rgba(255, 255, 255, 0.5); }
        .phase-bar:last-child { border-right: none; }
        .phase-0 { background-color: rgb(121, 209, 84); }
        .phase-1 { background-color: rgb(255, 230, 140); }
        .phase-2 { background-color: rgb(184, 152, 73); }
        .phase-label { font-size: 11px; color: #212529; font-weight: 600; white-space: nowrap; }
        .time-marker { position: absolute; bottom: -18px; transform: translateX(-50%); font-size: 11px; color: #495057; }
        .time-marker.end-marker { font-weight: bold; color: #c92a2a; }
        .profile-filename { font-size: 11px; color: #495057; margin-left: 8px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .time-axis { position: relative; height: 30px; border-top: 1px solid #dee2e6; margin-top: 35px; min-width: 700px; }
        .time-tick { position: absolute; bottom: 0; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; }
        .time-tick-line { width: 1px; height: 6px; background-color: #adb5bd; }
        .time-tick-label { font-size: 11px; color: #868e96; margin-top: 4px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Roasting Profile Analyzer</h1>
    <div class="upload-section">
        <input type="file" id="fileInput" multiple accept=".xlsx">
        <label for="fileInput" class="file-label">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.904-6.904a1 1 0 011.414 0l2.096 2.096V4a1 1 0 112 0v8.192l2.096-2.096a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
            파일 선택
        </label>
        <span id="fileCount">파일 0개</span>
        <button id="resetButton" style="display: none;">초기화</button>
    </div>
    <div id="profilesChartContainer" class="profiles-container" style="display: none;">
        <h2>Roasting Profiles</h2>
        <div id="profilesList"></div>
        <div id="timeAxisContainer"></div>
    </div>
</div>

<script>
    // --- 전역 변수 ---
    let profilesData = [];
    const fileInput = document.getElementById('fileInput');
    const fileCountSpan = document.getElementById('fileCount');
    const resetButton = document.getElementById('resetButton');
    const profilesChartContainer = document.getElementById('profilesChartContainer');
    const profilesListDiv = document.getElementById('profilesList');
    const timeAxisContainerDiv = document.getElementById('timeAxisContainer');

    // --- 도우미 함수 ---
    const timeToSeconds = (timeStr) => { if (!timeStr || typeof timeStr !== 'string' || !timeStr.includes(':')) return 0; const parts = timeStr.split(':'); if (parts.length !== 2) return 0; const [minutes, seconds] = parts.map(Number); if (isNaN(minutes) || isNaN(seconds)) return 0; return minutes * 60 + seconds; };
    const formatTime = (seconds) => { const totalSeconds = Math.max(0, Math.floor(seconds)); const mins = Math.floor(totalSeconds / 60); const secs = totalSeconds % 60; return `${mins}:${secs.toString().padStart(2, '0')}`; };

    // --- 프로파일 정렬 함수 ---
    const compareProfiles = (profileA, profileB) => {
        const numMatchA = profileA.fileName.match(/\d+/);
        const numMatchB = profileB.fileName.match(/\d+/);
        const numA = numMatchA ? parseInt(numMatchA[0], 10) : null;
        const numB = numMatchB ? parseInt(numMatchB[0], 10) : null;
        if (numA !== null && numB !== null) return numA - numB;
        else if (numA !== null) return -1;
        else if (numB !== null) return 1;
        else return profileA.fileName.localeCompare(profileB.fileName);
    };

    // 이벤트 리스너
    fileInput.addEventListener('change', handleFileUpload);
    resetButton.addEventListener('click', resetAnalysis);

    // 파일 업로드 처리
    async function handleFileUpload(event) {
        const files = Array.from(event.target.files);
        if (files.length === 0) return;
        const newFiles = files.filter(file => !profilesData.some(p => p.fileName === file.name));
        if (newFiles.length === 0 && files.length > 0) { alert("선택한 파일이 이미 로드되었습니다."); fileInput.value = ''; return; }
        if (newFiles.length === 0) return;
        const processingPromises = newFiles.map(file => processSingleFile(file));
        const newProcessedProfiles = await Promise.all(processingPromises);
        const validNewProfiles = newProcessedProfiles.filter(p => p !== null);
        if (validNewProfiles.length > 0) {
            profilesData = [...profilesData, ...validNewProfiles];
            profilesData.sort(compareProfiles);
            renderProfiles();
            fileCountSpan.textContent = `파일 ${profilesData.length}개`;
            resetButton.style.display = 'inline-block';
            profilesChartContainer.style.display = 'block';
        }
        fileInput.value = '';
    }

    // 단일 파일 처리
    async function processSingleFile(file) { /* ... */ }

    // 프로파일 데이터 분석
    function analyzeProfile(jsonData, fileName) { /* ... */ }

    // 프로파일 및 시간 축 렌더링
    function renderProfiles() {
        profilesListDiv.innerHTML = '';
        timeAxisContainerDiv.innerHTML = '';
        if (profilesData.length === 0) return;

        let maxOverallTime = 0;
        profilesData.forEach(p => { if (p.totalSeconds > maxOverallTime) maxOverallTime = p.totalSeconds; });
        const axisPaddingSeconds = 60;
        const axisDurationSeconds = Math.max(300, maxOverallTime + axisPaddingSeconds);

        profilesData.forEach(profile => {
            const profileRow = document.createElement('div'); profileRow.className = 'profile-row';
            const barContainer = document.createElement('div'); barContainer.className = 'timeline-bar-container';
            profile.phases.forEach((phase, index) => {
                const startPercent = (phase.startSeconds / axisDurationSeconds) * 100;
                const widthPercent = (phase.durationSeconds / axisDurationSeconds) * 100;
                const endSeconds = phase.startSeconds + phase.durationSeconds;
                const phaseBar = document.createElement('div'); phaseBar.className = `phase-bar phase-${index}`;
                phaseBar.style.left = `${startPercent}%`;
                phaseBar.style.width = `${widthPercent}%`;
                phaseBar.title = `${phase.name}: ${phase.percentage}% (${formatTime(phase.durationSeconds)}) RoR:${phase.avgRoR}`;
                const phaseLabel = document.createElement('span'); phaseLabel.className = 'phase-label';
                // 콤팩트 레이블 표시 (비율/시간/횟수)
                if (widthPercent >= 2) {
                    phaseLabel.textContent = `${phase.percentage}%/${formatTime(phase.durationSeconds)}/${phase.avgRoR}`;
                }
                phaseBar.appendChild(phaseLabel);
                barContainer.appendChild(phaseBar);
                if (index < profile.phases.length - 1) {
                    const midMarker = document.createElement('div'); midMarker.className = 'time-marker';
                    midMarker.style.left = `${(endSeconds / axisDurationSeconds) * 100}%`;
                    midMarker.textContent = formatTime(endSeconds);
                    barContainer.appendChild(midMarker);
                }
            });
            const endMarker = document.createElement('div'); endMarker.className = 'time-marker end-marker';
            endMarker.style.left = `${(profile.totalSeconds / axisDurationSeconds) * 100}%`;
            endMarker.textContent = formatTime(profile.totalSeconds);
            barContainer.appendChild(endMarker);
            const fileNameDiv = document.createElement('div'); fileNameDiv.className = 'profile-filename';
            fileNameDiv.textContent = profile.fileName;
            profileRow.appendChild(barContainer);
            profileRow.appendChild(fileNameDiv);
            profilesListDiv.appendChild(profileRow);
        });

        const timeAxis = document.createElement('div'); timeAxis.className = 'time-axis';
        const tickIntervalSeconds = 60;
        const numberOfTicks = Math.floor(axisDurationSeconds / tickIntervalSeconds);
        for (let i = 0; i <= numberOfTicks; i++) {
            const tickSeconds = i * tickIntervalSeconds;
            const tickPercent = (tickSeconds / axisDurationSeconds) * 100;
            if (tickPercent > 100.5) continue;
            const tickElement = document.createElement('div'); tickElement.className = 'time-tick';
            tickElement.style.left = `${tickPercent}%`;
            const tickLine = document.createElement('div'); tickLine.className = 'time-tick-line';
            const tickLabel = document.createElement('div'); tickLabel.className = 'time-tick-label';
            tickLabel
